import 'package:flutter/material.dart';
import 'package:fl_chart/fl_chart.dart';

void main() {
  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'FL Chart Demo',
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),
        useMaterial3: true,
      ),
      home: const BarChartPage(),
    );
  }
}

class BarChartPage extends StatefulWidget {
  const BarChartPage({super.key});

  @override
  State<BarChartPage> createState() => _BarChartPageState();
}

class _BarChartPageState extends State<BarChartPage> {
  int touchedIndex = -1;
  double? cursorPosition;

  // „Çµ„É≥„Éó„É´„Éá„Éº„ÇøÔºà2„Å§„ÅÆÁ≥ªÂàóÔºâ
  final List<ChartDataModel> chartData1 = [
    ChartDataModel(label: '1D', value: 6),
    ChartDataModel(label: '2D', value: 8),
    ChartDataModel(label: '3D', value: 5),
    ChartDataModel(label: '4D', value: 16),
    ChartDataModel(label: '5D', value: 15),
    ChartDataModel(label: '6D', value: 6),
    ChartDataModel(label: '7D', value: 15),
  ];

  final List<ChartDataModel> chartData2 = [
    ChartDataModel(label: '1D', value: 2),
    ChartDataModel(label: '2D', value: 6),
    ChartDataModel(label: '3D', value: 18),
    ChartDataModel(label: '4D', value: 15),
    ChartDataModel(label: '5D', value: 30),
    ChartDataModel(label: '6D', value: 22),
    ChartDataModel(label: '7D', value: 25),
  ];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('FL Chart Êäò„ÇåÁ∑ö„Ç∞„É©„Éï„Éá„É¢'),
        backgroundColor: Theme.of(context).colorScheme.inversePrimary,
      ),
      body: Padding(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          children: [
            // Âá°‰æã„ÇíËøΩÂä†
            Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                _buildLegendItem(
                    Colors.lightBlue, '„ÄåÊñ∞„Åó„ÅÑËá™ÂàÜ„Å´Âá∫‰ºö„Åä„ÅÜü§ó„Äç#Êñ∞Âπ¥„ÅÆÁõÆÊ®ô #Êó•Â∏∏„ÅÆÈ≠îÊ≥ï'),
                const SizedBox(width: 10),
                _buildLegendItem(Colors.blueGrey[800]!,
                    'A Healing Journey for the Soul - Vlog'),
              ],
            ),
            const SizedBox(height: 20),
            Expanded(
              child: Stack(
                children: [
                  GestureDetector(
                    onTapDown: (TapDownDetails details) {
                      _handleInteraction(details.localPosition);
                    },
                    onPanUpdate: (DragUpdateDetails details) {
                      _handleInteraction(details.localPosition);
                    },
                    child: LineChart(
                      LineChartData(
                        lineTouchData: LineTouchData(
                          enabled: false, // ÂÖÉ„ÅÆ„Çø„ÉÉ„ÉÅ„ÇíÁÑ°ÂäπÂåñ
                        ),
                        gridData: FlGridData(
                          show: true,
                          drawVerticalLine: false,
                          drawHorizontalLine: true,
                          horizontalInterval: 10,
                          getDrawingHorizontalLine: (value) {
                            return FlLine(
                              color: Colors.grey.withOpacity(0.2),
                              strokeWidth: 1,
                            );
                          },
                        ),
                        titlesData: FlTitlesData(
                          show: true,
                          bottomTitles: AxisTitles(
                            sideTitles: SideTitles(
                              showTitles: true,
                              getTitlesWidget: bottomTitleWidgets,
                              reservedSize: 32,
                            ),
                          ),
                          leftTitles: AxisTitles(
                            sideTitles: SideTitles(
                              showTitles: true,
                              reservedSize: 42,
                              interval: 10,
                              getTitlesWidget: leftTitleWidgets,
                            ),
                          ),
                          topTitles: const AxisTitles(
                            sideTitles: SideTitles(showTitles: false),
                          ),
                          rightTitles: const AxisTitles(
                            sideTitles: SideTitles(showTitles: false),
                          ),
                        ),
                        borderData: FlBorderData(show: false),
                        minX: 0,
                        maxX: (chartData1.length - 1).toDouble(),
                        minY: 0,
                        maxY: 35,
                        lineBarsData: [
                          // Á¨¨1Á≥ªÂàóÔºà„É©„Ç§„Éà„Éñ„É´„ÉºÔºâ
                          LineChartBarData(
                            spots: List.generate(chartData1.length, (index) {
                              return FlSpot(index.toDouble(),
                                  chartData1[index].value.toDouble());
                            }),
                            isCurved: false,
                            color: Colors.lightBlue,
                            barWidth: 3,
                            isStrokeCapRound: true,
                            dotData: FlDotData(
                              show: true,
                              getDotPainter: (spot, percent, barData, index) {
                                return FlDotCirclePainter(
                                  radius: 6,
                                  color: Colors.lightBlue,
                                  strokeWidth: 2,
                                  strokeColor: Colors.white,
                                );
                              },
                            ),
                            belowBarData: BarAreaData(show: false),
                          ),
                          // Á¨¨2Á≥ªÂàóÔºà„ÉÄ„Éº„ÇØ„Éñ„É´„ÉºÔºâ
                          LineChartBarData(
                            spots: List.generate(chartData2.length, (index) {
                              return FlSpot(index.toDouble(),
                                  chartData2[index].value.toDouble());
                            }),
                            isCurved: false,
                            color: Colors.blueGrey[800]!,
                            barWidth: 3,
                            isStrokeCapRound: true,
                            dotData: FlDotData(
                              show: true,
                              getDotPainter: (spot, percent, barData, index) {
                                return FlDotCirclePainter(
                                  radius: 6,
                                  color: Colors.blueGrey[800]!,
                                  strokeWidth: 2,
                                  strokeColor: Colors.white,
                                );
                              },
                            ),
                            belowBarData: BarAreaData(show: false),
                          ),
                        ],
                      ),
                    ),
                  ),
                  if (cursorPosition != null)
                    Positioned(
                      left: _getCursorXPosition(),
                      top: 0,
                      bottom: 32, // bottomTitles„ÅÆÈ´ò„ÅïÂàÜ‰∏ä„Åí„Çã
                      child: CustomPaint(
                        painter: DashedLinePainter(
                          color: Colors.lightBlue,
                          strokeWidth: 2,
                          dashWidth: 5,
                          dashSpace: 3,
                        ),
                        child: Container(
                          width: 2,
                          child: Column(
                            children: [
                              Container(
                                width: 8,
                                height: 8,
                                decoration: BoxDecoration(
                                  color: Colors.lightBlue,
                                  shape: BoxShape.circle,
                                  border:
                                      Border.all(color: Colors.white, width: 2),
                                  boxShadow: [
                                    BoxShadow(
                                      color: Colors.lightBlue.withOpacity(0.3),
                                      blurRadius: 4,
                                      spreadRadius: 1,
                                    ),
                                  ],
                                ),
                              ),
                              Expanded(child: Container()),
                            ],
                          ),
                        ),
                      ),
                    ),
                  // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíÊäò„ÇåÁ∑ö„Ç∞„É©„Éï„ÅÆ„Éù„Ç§„É≥„Éà‰∏ä„Å´Ë°®Á§∫
                  if (cursorPosition != null && touchedIndex >= 0)
                    Positioned(
                      left: _getTooltipXPosition(),
                      top: _getTooltipYPosition(),
                      child: Container(
                        padding: const EdgeInsets.symmetric(
                            horizontal: 12, vertical: 8),
                        decoration: BoxDecoration(
                          color: Colors.black87,
                          borderRadius: BorderRadius.circular(8),
                          boxShadow: [
                            BoxShadow(
                              color: Colors.black.withOpacity(0.3),
                              blurRadius: 6,
                              offset: const Offset(0, 3),
                            ),
                          ],
                        ),
                        child: Column(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Text(
                              '${chartData1[touchedIndex].label}',
                              style: const TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                                fontSize: 14,
                              ),
                            ),
                            const SizedBox(height: 4),
                            // Á¨¨1Á≥ªÂàó„ÅÆ„Éá„Éº„Çø
                            Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Container(
                                  width: 12,
                                  height: 2,
                                  color: Colors.lightBlue,
                                ),
                                const SizedBox(width: 6),
                                Text(
                                  '${chartData1[touchedIndex].value}',
                                  style: const TextStyle(
                                    color: Colors.lightBlue,
                                    fontWeight: FontWeight.bold,
                                    fontSize: 16,
                                  ),
                                ),
                              ],
                            ),
                            const SizedBox(height: 2),
                            // Á¨¨2Á≥ªÂàó„ÅÆ„Éá„Éº„Çø
                            Row(
                              mainAxisSize: MainAxisSize.min,
                              children: [
                                Container(
                                  width: 12,
                                  height: 2,
                                  color: Colors.blueGrey[800]!,
                                ),
                                const SizedBox(width: 6),
                                Text(
                                  '${chartData2[touchedIndex].value}',
                                  style: TextStyle(
                                    color: Colors.blueGrey[800]!,
                                    fontWeight: FontWeight.bold,
                                    fontSize: 16,
                                  ),
                                ),
                              ],
                            ),
                          ],
                        ),
                      ),
                    ),
                ],
              ),
            ),
            if (cursorPosition != null && touchedIndex >= 0)
              Container(
                margin: const EdgeInsets.only(top: 16),
                padding: const EdgeInsets.all(12),
                decoration: BoxDecoration(
                  color: Colors.blueGrey,
                  borderRadius: BorderRadius.circular(8),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withOpacity(0.2),
                      blurRadius: 4,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: Column(
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Text(
                      '${chartData1[touchedIndex].label}',
                      style: const TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                        fontSize: 16,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                      children: [
                        Column(
                          children: [
                            Text(
                              'Á≥ªÂàó1',
                              style: const TextStyle(
                                color: Colors.lightBlue,
                                fontSize: 12,
                              ),
                            ),
                            Text(
                              '${chartData1[touchedIndex].value}',
                              style: const TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                                fontSize: 14,
                              ),
                            ),
                          ],
                        ),
                        Column(
                          children: [
                            Text(
                              'Á≥ªÂàó2',
                              style: TextStyle(
                                color: Colors.blueGrey[300]!,
                                fontSize: 12,
                              ),
                            ),
                            Text(
                              '${chartData2[touchedIndex].value}',
                              style: const TextStyle(
                                color: Colors.white,
                                fontWeight: FontWeight.bold,
                                fontSize: 14,
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                    const SizedBox(height: 4),
                    Text(
                      '„Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ: ${cursorPosition!.toStringAsFixed(2)}',
                      style: const TextStyle(
                        color: Colors.white70,
                        fontSize: 12,
                      ),
                    ),
                  ],
                ),
              ),
          ],
        ),
      ),
    );
  }

  void _handleInteraction(Offset localPosition) {
    // „ÉÅ„É£„Éº„Éà„Ç®„É™„Ç¢„ÅÆÁØÑÂõ≤„ÇíË®àÁÆó
    const double leftMargin = 42; // leftTitles reserved size
    const double rightMargin = 16; // padding right

    final double chartAreaWidth = MediaQuery.of(context).size.width -
        leftMargin -
        rightMargin -
        32; // 32 = padding left + right
    final double tapX = localPosition.dx;

    // „Çø„ÉÉ„Éó‰ΩçÁΩÆ„Åå„ÉÅ„É£„Éº„Éà„Ç®„É™„Ç¢ÂÜÖ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    if (tapX < leftMargin || tapX > (leftMargin + chartAreaWidth)) {
      return; // „ÉÅ„É£„Éº„Éà„Ç®„É™„Ç¢Â§ñ„ÅÆÂ†¥Âêà„ÅØÁÑ°Ë¶ñ
    }

    // „ÉÅ„É£„Éº„Éà„Ç®„É™„Ç¢ÂÜÖ„Åß„ÅÆÁõ∏ÂØæ‰ΩçÁΩÆ„ÇíË®àÁÆó
    final double relativeX = tapX - leftMargin;
    final double normalizedPosition = relativeX / chartAreaWidth;

    // ‰ΩçÁΩÆ„Çí0.0 - (chartData1.length - 1)„ÅÆÁØÑÂõ≤„Å´„Éû„ÉÉ„Éî„É≥„Ç∞
    final double exactPosition = normalizedPosition * (chartData1.length - 1);
    final double clampedPosition =
        exactPosition.clamp(0.0, (chartData1.length - 1).toDouble());

    // ‰∏ÄÁï™Ëøë„ÅÑÊ£í„Ç∞„É©„Éï„ÅÆ„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„ÇíË®àÁÆó
    final int nearestIndex = clampedPosition.round();

    setState(() {
      cursorPosition = clampedPosition; // Ê≠£Á¢∫„Å™‰ΩçÁΩÆ„Çí‰øùÂ≠ò
      touchedIndex = nearestIndex;
    });
  }

  double _getCursorXPosition() {
    if (cursorPosition == null) return 0;

    // „ÉÅ„É£„Éº„Éà„Ç®„É™„Ç¢„ÅÆÂπÖ„ÇíË®àÁÆóÔºàÂ∑¶„ÅÆ‰ΩôÁôΩ + Ê£í„Ç∞„É©„Éï„Ç®„É™„Ç¢„Åß„ÅÆ‰ΩçÁΩÆÔºâ
    const double leftMargin = 42; // leftTitles reserved size
    const double rightMargin = 16; // padding

    // ÁîªÈù¢ÂπÖ„Åã„Çâ„Éû„Éº„Ç∏„É≥„ÇíÂºï„ÅÑ„Å¶„ÉÅ„É£„Éº„ÉàÂπÖ„ÇíË®àÁÆó
    final double chartWidth = MediaQuery.of(context).size.width -
        leftMargin -
        rightMargin -
        32; // 32 = padding left + right

    // „Ç´„Éº„ÇΩ„É´‰ΩçÁΩÆ„Çí„Éî„ÇØ„Çª„É´‰ΩçÁΩÆ„Å´Â§âÊèõ
    final double normalizedPosition = cursorPosition! / (chartData1.length - 1);
    final double position = leftMargin + (normalizedPosition * chartWidth);

    return position;
  }

  Widget leftTitleWidgets(double value, TitleMeta meta) {
    const style = TextStyle(
      color: Colors.black,
      fontWeight: FontWeight.normal,
      fontSize: 12,
    );
    if (value == 0) return Text('0', style: style);
    if (value == 10) return Text('10K', style: style);
    if (value == 20) return Text('20K', style: style);
    if (value == 30) return Text('30K', style: style);
    return const SizedBox();
  }

  Widget bottomTitleWidgets(double value, TitleMeta meta) {
    const style = TextStyle(
      color: Colors.black,
      fontWeight: FontWeight.bold,
      fontSize: 12,
    );

    if (value.toInt() < chartData1.length) {
      return Text(chartData1[value.toInt()].label, style: style);
    }
    return const SizedBox();
  }

  double _getTooltipXPosition() {
    if (cursorPosition == null) return 0;

    // „Ç´„Éº„ÇΩ„É´„ÅÆ‰∏≠Â§Æ‰ΩçÁΩÆ„ÇíÂèñÂæó
    final double cursorX = _getCursorXPosition();

    // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆÂπÖ„ÇíËÄÉÊÖÆ„Åó„Å¶‰∏≠Â§ÆÈÖçÁΩÆÔºà„ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÂπÖ„Çí120„Å®‰ªÆÂÆöÔºâ
    const double tooltipWidth = 120;
    double tooltipX = cursorX - (tooltipWidth / 2);

    // ÁîªÈù¢Á´Ø„Åã„Çâ„ÅØ„ÅøÂá∫„Åï„Å™„ÅÑ„Çà„ÅÜ„Å´Ë™øÊï¥
    const double margin = 8;
    final double screenWidth = MediaQuery.of(context).size.width;

    if (tooltipX < margin) {
      tooltipX = margin;
    } else if (tooltipX + tooltipWidth > screenWidth - margin) {
      tooltipX = screenWidth - tooltipWidth - margin;
    }

    return tooltipX;
  }

  double _getTooltipYPosition() {
    if (touchedIndex < 0) return 0;

    // „Çà„ÇäÈ´ò„ÅÑÊñπ„ÅÆÂÄ§„ÇíÂü∫Ê∫ñ„Å´„Åó„Å¶„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíÈÖçÁΩÆ
    final double value1 = chartData1[touchedIndex].value.toDouble();
    final double value2 = chartData2[touchedIndex].value.toDouble();
    final double maxPointValue = value1 > value2 ? value1 : value2;
    
    // „ÉÅ„É£„Éº„Éà„ÅÆÂõ∫ÂÆöÂÄ§
    const double maxChartValue = 35.0;
    const double topMargin = 56 + 16 + 20 + 20; // AppBar + padding + legend + spacing
    
    // Âà©Áî®ÂèØËÉΩ„Å™„ÉÅ„É£„Éº„ÉàÈ´ò„Åï„ÇíÂèñÂæó
    final RenderBox? renderBox = context.findRenderObject() as RenderBox?;
    final double availableHeight = renderBox?.size.height ?? MediaQuery.of(context).size.height;
    final double chartAreaHeight = availableHeight - topMargin - 32 - 100; // bottom‰∫àÁ¥ÑÈ†òÂüü„ÇíÈô§„Åè
    
    // „Éù„Ç§„É≥„Éà„ÅÆY‰ΩçÁΩÆ„ÇíË®àÁÆóÔºà„ÉÅ„É£„Éº„Éà„Ç®„É™„Ç¢ÂÜÖ„Åß„ÅÆÁõ∏ÂØæ‰ΩçÁΩÆÔºâ
    final double relativeY = 1.0 - (maxPointValue / maxChartValue);
    final double pointY = topMargin + (relativeY * chartAreaHeight);
    
    // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„Çí„Éù„Ç§„É≥„Éà„ÅÆ‰∏ä„Å´ÈÖçÁΩÆÔºàÂõ∫ÂÆö„Ç™„Éï„Çª„ÉÉ„ÉàÔºâ
    const double tooltipHeight = 100; // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÅÆÊ¶ÇÁÆóÈ´ò„Åï
    double tooltipY = pointY - tooltipHeight - 10; // 10px„ÅÆ„Éû„Éº„Ç∏„É≥
    
    // ‰∏äÁ´Ø„Åã„Çâ„ÅØ„ÅøÂá∫„Åï„Å™„ÅÑ„Çà„ÅÜ„Å´Ë™øÊï¥
    const double minY = topMargin + 10;
    if (tooltipY < minY) {
      tooltipY = pointY + 20; // „Éù„Ç§„É≥„Éà„ÅÆ‰∏ã„Å´Ë°®Á§∫
    }
    
    return tooltipY;
  }

  Widget _buildLegendItem(Color color, String text) {
    return Row(
      mainAxisSize: MainAxisSize.min,
      children: [
        Container(
          width: 16,
          height: 3,
          decoration: BoxDecoration(
            color: color,
            borderRadius: BorderRadius.circular(1.5),
          ),
        ),
        const SizedBox(width: 6),
        SizedBox(
          width: 200,
          child: Text(
            text,
            style: const TextStyle(
              fontSize: 10,
              color: Colors.black87,
            ),
            overflow: TextOverflow.ellipsis,
          ),
        ),
      ],
    );
  }
}

class ChartDataModel {
  final String label;
  final int value;

  ChartDataModel({required this.label, required this.value});
}

class DashedLinePainter extends CustomPainter {
  final Color color;
  final double strokeWidth;
  final double dashWidth;
  final double dashSpace;

  DashedLinePainter({
    required this.color,
    this.strokeWidth = 2.0,
    this.dashWidth = 5.0,
    this.dashSpace = 3.0,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = color
      ..strokeWidth = strokeWidth
      ..style = PaintingStyle.stroke;

    double startY = 0;
    final double endY = size.height;
    final double x = size.width / 2;

    while (startY < endY) {
      canvas.drawLine(
        Offset(x, startY),
        Offset(x, (startY + dashWidth).clamp(0, endY)),
        paint,
      );
      startY += dashWidth + dashSpace;
    }
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => false;
}
